import{j as e,C as E,a as q,T as t,o as D,B as d,e as h,ah as he,w as C,an as O,G as l,f as I,h as z,aq as ue,ar as je,as as me,g as _,at as pe,y as ye,i as fe,z as ge,F as ve,H as G,J as n,K as be,au as De,af as W,V as Ce,N as ke,ak as we,al as H,am as Se,W as L,X as M,Z as X,_ as N,$ as V,a0 as J,a1 as K,a2 as T,av as Z,a3 as $,ao as Ae,ap as Ie,aw as ze,x as We,ax as Q}from"./ui-4acb94fb.js";import{r as o}from"./vendor-c1fc8f85.js";import{W as Te}from"./index-8b3557c4.js";import{d as y}from"./documentsApi-d63edb6d.js";import{b as Be}from"./router-7ed49354.js";import"./utils-4719f846.js";import"./query-956dc969.js";const Ue=()=>{const Y=Be(),[f,ee]=o.useState(null),[u,j]=o.useState(null),[se,m]=o.useState(!1),[te,k]=o.useState(!1),[re,P]=o.useState(!0),[i,w]=o.useState(!1),[g,v]=o.useState(null),[b,B]=o.useState({open:!1,message:"",severity:"success"}),[a,x]=o.useState({title:"",description:"",category:"charter",expiryDate:"",status:"active"}),R=[{key:"charter",label:"Устав",icon:e.jsx(C,{}),color:"primary"},{key:"license",label:"Лицензия",icon:e.jsx(We,{}),color:"success"},{key:"accreditation",label:"Аккредитация",icon:e.jsx(Q,{}),color:"warning"},{key:"regulations",label:"Правила распорядка",icon:e.jsx(C,{}),color:"info"},{key:"reports",label:"Отчеты самообследования",icon:e.jsx(C,{}),color:"secondary"},{key:"collective",label:"Коллективный договор",icon:e.jsx(C,{}),color:"primary"},{key:"prescriptions",label:"Предписания",icon:e.jsx(Q,{}),color:"error"}];o.useEffect(()=>{F()},[]);const F=async()=>{try{P(!0);const s=await y.getDocuments();ee(s.data)}catch(s){console.error("Ошибка загрузки документов:",s),p("Ошибка загрузки документов","error")}finally{P(!1)}},p=(s,c)=>{B({open:!0,message:s,severity:c})},ie=()=>{if(!f)return[];const s=[];return Object.values(f).forEach(c=>{Array.isArray(c)&&s.push(...c)}),s},ae=s=>{switch(s){case"active":return"success";case"expired":return"error";case"not_required":return"info";default:return"default"}},le=s=>{switch(s){case"active":return"Активный";case"expired":return"Просрочен";case"not_required":return"Не требуется";default:return s}},ne=s=>{j(s),x({title:s.title,description:s.description,category:s.category||"charter",expiryDate:s.expiryDate||"",status:s.status||"active"}),v(null),m(!0)},ce=s=>{j(s),k(!0)},oe=async()=>{try{w(!0),u?(await y.updateDocument(u.id,{...a,file:g||void 0}),p("Документ успешно обновлен","success")):(await y.createDocument({...a,file:g||void 0}),p("Документ успешно создан","success")),await F(),m(!1),j(null),v(null)}catch(s){console.error("Ошибка сохранения документа:",s),p(s.message||"Ошибка сохранения документа","error")}finally{w(!1)}},de=async()=>{if(u)try{w(!0),await y.deleteDocument(u.id),p("Документ успешно удален","success"),await F(),k(!1),j(null)}catch(s){console.error("Ошибка удаления документа:",s),p(s.message||"Ошибка удаления документа","error")}finally{w(!1)}},xe=s=>{const c=s.target.files?.[0];c&&v(c)},U=()=>{j(null),x({title:"",description:"",category:"charter",expiryDate:"",status:"active"}),v(null),m(!0)};if(re)return e.jsxs(E,{maxWidth:"xl",sx:{py:8,textAlign:"center"},children:[e.jsx(q,{size:40}),e.jsx(t,{variant:"h6",sx:{mt:2},children:"Загрузка документов..."})]});if(!f)return e.jsx(E,{maxWidth:"xl",sx:{py:8},children:e.jsx(D,{severity:"error",children:"Не удалось загрузить документы"})});const S=ie(),A={total:S.length,active:S.filter(s=>s.status==="active").length,expired:S.filter(s=>s.status==="expired").length,notRequired:S.filter(s=>s.status==="not_required").length};return e.jsxs(e.Fragment,{children:[e.jsxs(Te,{children:[e.jsx("title",{children:"Управление документами - РУЛЬ+ Админ"}),e.jsx("meta",{name:"robots",content:"noindex,nofollow"})]}),e.jsxs(E,{maxWidth:"xl",sx:{py:4},children:[e.jsxs(d,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:4},children:[e.jsxs(d,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(h,{startIcon:e.jsx(he,{}),onClick:()=>Y("/admin"),sx:{mr:2},children:"Назад"}),e.jsx(C,{sx:{mr:2,fontSize:32,color:"primary.main"}}),e.jsxs(d,{children:[e.jsx(t,{variant:"h4",component:"h1",fontWeight:"bold",children:"Управление документами"}),e.jsx(t,{variant:"body1",color:"text.secondary",children:"Управление документами образовательной организации"})]})]}),e.jsx(h,{variant:"contained",startIcon:e.jsx(O,{}),onClick:U,size:"large",children:"Добавить документ"})]}),e.jsxs(l,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(l,{item:!0,xs:12,sm:6,md:3,children:e.jsx(I,{children:e.jsxs(z,{children:[e.jsx(t,{color:"text.secondary",gutterBottom:!0,children:"Всего документов"}),e.jsx(t,{variant:"h4",color:"primary",children:A.total})]})})}),e.jsx(l,{item:!0,xs:12,sm:6,md:3,children:e.jsx(I,{children:e.jsxs(z,{children:[e.jsx(t,{color:"text.secondary",gutterBottom:!0,children:"Активных"}),e.jsx(t,{variant:"h4",color:"success.main",children:A.active})]})})}),e.jsx(l,{item:!0,xs:12,sm:6,md:3,children:e.jsx(I,{children:e.jsxs(z,{children:[e.jsx(t,{color:"text.secondary",gutterBottom:!0,children:"Просроченных"}),e.jsx(t,{variant:"h4",color:"error.main",children:A.expired})]})})}),e.jsx(l,{item:!0,xs:12,sm:6,md:3,children:e.jsx(I,{children:e.jsxs(z,{children:[e.jsx(t,{color:"text.secondary",gutterBottom:!0,children:"Не требуется"}),e.jsx(t,{variant:"h4",color:"info.main",children:A.notRequired})]})})})]}),R.map(s=>{const c=Array.isArray(f[s.key])?f[s.key]:[];return e.jsxs(ue,{defaultExpanded:!0,sx:{mb:2},children:[e.jsx(je,{expandIcon:e.jsx(me,{}),children:e.jsxs(d,{sx:{display:"flex",alignItems:"center",width:"100%"},children:[s.icon,e.jsx(t,{variant:"h6",sx:{ml:2,flexGrow:1},children:s.label}),e.jsx(_,{label:c.length,size:"small",color:s.color,sx:{mr:2}}),e.jsx(h,{size:"small",variant:"outlined",startIcon:e.jsx(O,{}),onClick:r=>{r.stopPropagation(),x({title:"",description:"",category:s.key,expiryDate:"",status:"active"}),j(null),v(null),m(!0)},sx:{ml:1},children:"Добавить"})]})}),e.jsx(pe,{children:c.length>0?e.jsx(ye,{component:fe,variant:"outlined",children:e.jsxs(ge,{children:[e.jsx(ve,{children:e.jsxs(G,{children:[e.jsx(n,{children:"Документ"}),e.jsx(n,{children:"Файл"}),e.jsx(n,{children:"Дата загрузки"}),e.jsx(n,{children:"Срок действия"}),e.jsx(n,{children:"Статус"}),e.jsx(n,{align:"center",children:"Действия"})]})}),e.jsx(be,{children:c.map(r=>e.jsxs(G,{hover:!0,children:[e.jsx(n,{children:e.jsxs(d,{children:[e.jsx(t,{variant:"subtitle2",fontWeight:"medium",children:r.title}),e.jsx(t,{variant:"body2",color:"text.secondary",children:r.description})]})}),e.jsx(n,{children:r.fileName?e.jsxs(d,{children:[e.jsx(t,{variant:"body2",children:r.fileName}),e.jsx(t,{variant:"caption",color:"text.secondary",children:r.fileSize})]}):e.jsx(t,{variant:"body2",color:"text.secondary",children:"Файл не загружен"})}),e.jsx(n,{children:r.uploadDate}),e.jsx(n,{children:r.expiryDate?e.jsx(t,{variant:"body2",color:new Date(r.expiryDate)<new Date?"error":"inherit",children:r.expiryDate}):e.jsx(t,{variant:"body2",color:"text.secondary",children:"Бессрочно"})}),e.jsx(n,{children:e.jsx(_,{label:le(r.status||"active"),size:"small",color:ae(r.status||"active")})}),e.jsx(n,{align:"center",children:e.jsxs(De,{direction:"row",spacing:1,children:[r.fileUrl&&e.jsxs(e.Fragment,{children:[e.jsx(W,{size:"small",onClick:()=>y.viewDocument(r.fileUrl),title:"Просмотр",children:e.jsx(Ce,{})}),e.jsx(W,{size:"small",onClick:()=>y.downloadDocument(r.fileUrl,r.fileName||r.title),title:"Скачать",children:e.jsx(ke,{})})]}),e.jsx(W,{size:"small",onClick:()=>ne(r),title:"Редактировать",children:e.jsx(we,{})}),e.jsx(W,{size:"small",onClick:()=>ce(r),title:"Удалить",color:"error",children:e.jsx(H,{})})]})})]},r.id))})]})}):e.jsx(d,{sx:{textAlign:"center",py:3},children:e.jsx(D,{severity:"info",children:"В данной категории документы отсутствуют"})})})]},s.key)}),e.jsx(Se,{color:"primary","aria-label":"add",sx:{position:"fixed",bottom:24,right:24},onClick:U,children:e.jsx(O,{})}),e.jsxs(L,{open:se,onClose:()=>!i&&m(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(M,{children:u?"Редактировать документ":"Добавить новый документ"}),e.jsx(X,{children:e.jsx(d,{sx:{pt:2},children:e.jsxs(l,{container:!0,spacing:3,children:[e.jsx(l,{item:!0,xs:12,children:e.jsx(N,{fullWidth:!0,label:"Название документа",value:a.title,onChange:s=>x({...a,title:s.target.value}),disabled:i})}),e.jsx(l,{item:!0,xs:12,children:e.jsx(N,{fullWidth:!0,label:"Описание",multiline:!0,rows:3,value:a.description,onChange:s=>x({...a,description:s.target.value}),disabled:i})}),e.jsx(l,{item:!0,xs:12,sm:6,children:e.jsxs(V,{fullWidth:!0,disabled:i,children:[e.jsx(J,{children:"Категория"}),e.jsx(K,{value:a.category,label:"Категория",onChange:s=>x({...a,category:s.target.value}),children:R.map(s=>e.jsx(T,{value:s.key,children:s.label},s.key))})]})}),e.jsx(l,{item:!0,xs:12,sm:6,children:e.jsxs(V,{fullWidth:!0,disabled:i,children:[e.jsx(J,{children:"Статус"}),e.jsxs(K,{value:a.status,label:"Статус",onChange:s=>x({...a,status:s.target.value}),children:[e.jsx(T,{value:"active",children:"Активный"}),e.jsx(T,{value:"expired",children:"Просрочен"}),e.jsx(T,{value:"not_required",children:"Не требуется"})]})]})}),e.jsx(l,{item:!0,xs:12,children:e.jsxs(d,{sx:{border:"2px dashed #ccc",borderRadius:2,p:3,textAlign:"center"},children:[e.jsx(Z,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(t,{variant:"h6",gutterBottom:!0,children:"Загрузить файл документа"}),e.jsx(t,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Разрешены файлы: PDF, DOC, DOCX, TXT (максимум 10 МБ)"}),e.jsxs(h,{variant:"outlined",component:"label",startIcon:e.jsx(Z,{}),disabled:i,children:["Выбрать файл",e.jsx("input",{type:"file",hidden:!0,accept:".pdf,.doc,.docx,.txt",onChange:xe})]}),g&&e.jsxs(D,{severity:"success",sx:{mt:2},children:["Файл выбран: ",g.name," (",(g.size/1024/1024).toFixed(1)," МБ)"]})]})}),e.jsx(l,{item:!0,xs:12,sm:6,children:e.jsx(N,{fullWidth:!0,label:"Срок действия",type:"date",value:a.expiryDate,onChange:s=>x({...a,expiryDate:s.target.value}),InputLabelProps:{shrink:!0},helperText:"Оставьте пустым для бессрочного документа",disabled:i})})]})})}),e.jsxs($,{children:[e.jsx(h,{onClick:()=>m(!1),startIcon:e.jsx(Ae,{}),disabled:i,children:"Отмена"}),e.jsx(h,{onClick:oe,variant:"contained",startIcon:i?e.jsx(q,{size:16}):e.jsx(Ie,{}),disabled:i||!a.title.trim()||!a.description.trim(),children:i?"Сохранение...":"Сохранить"})]})]}),e.jsxs(L,{open:te,onClose:()=>!i&&k(!1),children:[e.jsx(M,{children:"Подтверждение удаления"}),e.jsxs(X,{children:[e.jsx(D,{severity:"warning",sx:{mb:2},children:"Это действие нельзя отменить!"}),e.jsxs(t,{children:['Вы уверены, что хотите удалить документ "',u?.title,'"?']})]}),e.jsxs($,{children:[e.jsx(h,{onClick:()=>k(!1),disabled:i,children:"Отмена"}),e.jsx(h,{onClick:de,color:"error",variant:"contained",disabled:i,startIcon:i?e.jsx(q,{size:16}):e.jsx(H,{}),children:i?"Удаление...":"Удалить"})]})]}),e.jsx(ze,{open:b.open,autoHideDuration:6e3,onClose:()=>B({...b,open:!1}),children:e.jsx(D,{onClose:()=>B({...b,open:!1}),severity:b.severity,sx:{width:"100%"},children:b.message})})]})]})};export{Ue as default};
//# sourceMappingURL=index-7809754f.js.map
